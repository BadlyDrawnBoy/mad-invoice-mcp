{% extends "layout.html" %}
{% block content %}
<div class="panel">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:16px; flex-wrap:wrap;">
        <div>
            <h2 style="margin:0;">Invoice {{ invoice.invoice_number }}</h2>
            <div class="muted">ID: {{ invoice.id }}</div>
        </div>
    <div class="actions">
      <form method="post" action="/invoices/{{ invoice.id }}/render">
        <button type="submit">Render PDF</button>
      </form>

      {% if invoice.status == "draft" %}
      <form method="post" action="/invoices/{{ invoice.id }}/finalize"
            onsubmit="return confirm('Finalize invoice? This cannot be undone.');">
        <button type="submit" class="btn-success">Finalize</button>
      </form>
      <form method="post" action="/invoices/{{ invoice.id }}/delete"
            onsubmit="return confirm('Delete this draft? This cannot be undone.');">
        <button type="submit" class="btn-danger">Delete Draft</button>
      </form>
      {% else %}
      <form method="post" action="/invoices/{{ invoice.id }}/mark-paid">
        <button type="submit" class="btn-secondary">Mark paid</button>
      </form>
      {% endif %}
    </div>
  </div>

    <div style="margin-top:18px; display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:18px;">
        <div>
            <h4 style="margin:0 0 6px;">Meta</h4>
            <dl>
                <dt>Invoice date</dt><dd>{{ invoice.invoice_date }}</dd>
                <dt>Due date</dt><dd>{{ invoice.due_date }}</dd>
                <dt>Status</dt><dd><span class="pill pill-open">{{ invoice.status }}</span></dd>
        <dt>Payment status</dt>
        <dd>
          {% if invoice.payment_status == "paid" %}
            <span class="pill pill-paid">paid</span>
          {% elif invoice.payment_status == "overdue" %}
            <span class="pill pill-overdue">overdue</span>
          {% else %}
            <span class="pill pill-open">{{ invoice.payment_status }}</span>
          {% endif %}
        </dd>
        <dt>Project</dt><dd>{{ invoice.project or "—" }}</dd>
        <dt>PDF</dt><dd>{{ "available" if pdf_exists else "missing" }}</dd>
        <dt>Language</dt><dd>{{ invoice.language }}</dd>
      </dl>
    </div>
        <div>
            <h4 style="margin:0 0 6px;">Supplier</h4>
            <dl>
                <dt>Name</dt>
                <dd>{{ invoice.supplier.name }}{% if invoice.supplier.business_name %}<br><span class="muted">{{ invoice.supplier.business_name }}</span>{% endif %}</dd>
                <dt>Address</dt>
                <dd>{{ invoice.supplier.street }}<br>{{ invoice.supplier.postal_code }} {{ invoice.supplier.city }}<br>{{ invoice.supplier.country }}</dd>
                {% if invoice.supplier.email or invoice.supplier.phone %}
                <dt>Contact</dt>
                <dd>
                  {% if invoice.supplier.email %}{{ invoice.supplier.email }}{% if invoice.supplier.phone %}<br>{% endif %}{% endif %}
                  {% if invoice.supplier.phone %}{{ invoice.supplier.phone }}{% endif %}
                </dd>
                {% endif %}
            </dl>
        </div>
        <div>
            <h4 style="margin:0 0 6px;">Customer</h4>
            <dl>
                <dt>Name</dt>
                <dd>{{ invoice.customer.name }}{% if invoice.customer.business_name %}<br><span class="muted">{{ invoice.customer.business_name }}</span>{% endif %}</dd>
                <dt>Address</dt>
                <dd>{{ invoice.customer.street }}<br>{{ invoice.customer.postal_code }} {{ invoice.customer.city }}<br>{{ invoice.customer.country }}</dd>
                {% if invoice.customer.email or invoice.customer.phone %}
                <dt>Contact</dt>
                <dd>
                  {% if invoice.customer.email %}{{ invoice.customer.email }}{% if invoice.customer.phone %}<br>{% endif %}{% endif %}
                  {% if invoice.customer.phone %}{{ invoice.customer.phone }}{% endif %}
                </dd>
                {% endif %}
            </dl>
        </div>
        <div>
            <h4 style="margin:0 0 6px;">Financial</h4>
            <dl>
                <dt>Currency</dt><dd>{{ invoice.currency }}</dd>
                <dt>VAT</dt><dd>{{ "%.1f"|format(invoice.vat_rate * 100) }} %</dd>
                <dt>Small business</dt><dd>{{ "Yes (§19 UStG)" if invoice.small_business else "No" }}</dd>
            </dl>
        </div>
    </div>

    <div style="margin-top:22px;">
        <h4 style="margin-bottom:8px;">Line items</h4>
        <table>
            <thead>
                <tr>
                    <th>#</th>
                    <th>Description</th>
                    <th>Qty</th>
                    <th>Unit price</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ item.description }}</td>
                    <td>{{ item.quantity }} {{ item.unit }}</td>
                    <td>{{ "%.2f"|format(item.unit_price) }} {{ invoice.currency }}</td>
                    <td>{{ "%.2f"|format(item.total) }} {{ invoice.currency }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div style="margin-top:14px; display:flex; justify-content:flex-end;">
          <table style="max-width:320px;">
            <tbody>
              <tr><td class="muted">Subtotal</td><td style="text-align:right;">{{ "%.2f"|format(invoice.subtotal()) }} {{ invoice.currency }}</td></tr>
              {% if not invoice.small_business and invoice.vat_rate > 0 %}
              <tr><td class="muted">VAT ({{ "%.1f"|format(invoice.vat_rate * 100) }}%)</td><td style="text-align:right;">{{ "%.2f"|format(invoice.vat_amount()) }} {{ invoice.currency }}</td></tr>
              {% endif %}
              <tr><td><strong>Total</strong></td><td style="text-align:right;"><strong>{{ "%.2f"|format(invoice.total()) }} {{ invoice.currency }}</strong></td></tr>
            </tbody>
          </table>
        </div>
    </div>
</div>
{% endblock %}
