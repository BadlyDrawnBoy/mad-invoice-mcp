{% extends "layout.html" %}
{% block content %}
{% macro sortable_header(label, field) -%}
  {% set active = sort == field %}
  {% set next_dir = 'desc' if active and direction == 'asc' else 'asc' %}
  {% set arrow = '↑' if active and direction == 'asc' else '↓' if active else '' %}
  <a class="sort-link{% if active %} active{% endif %}" href="?sort={{ field }}&dir={{ next_dir }}">
    <span>{{ label }}</span>{% if arrow %}<span class="arrow">{{ arrow }}</span>{% endif %}
  </a>
{%- endmacro %}
<div class="panel">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:14px;">
    <div>
      <h2 style="margin:0;">Invoices</h2>
      <div class="muted">{{ count }} entries · Default sort: newest invoice date</div>
    </div>
    <form method="get" style="display:flex; gap:8px; align-items:center;">
      <label for="sort" class="muted">Sort by</label>
      <select id="sort" name="sort">
        <option value="invoice_date" {% if sort == "invoice_date" %}selected{% endif %}>Invoice date</option>
        <option value="due_date" {% if sort == "due_date" %}selected{% endif %}>Due date</option>
        <option value="customer" {% if sort == "customer" %}selected{% endif %}>Customer</option>
        <option value="invoice_number" {% if sort == "invoice_number" %}selected{% endif %}>Invoice number</option>
        <option value="total" {% if sort == "total" %}selected{% endif %}>Amount</option>
      </select>
      <select name="dir">
        <option value="desc" {% if direction == "desc" %}selected{% endif %}>Descending</option>
        <option value="asc" {% if direction == "asc" %}selected{% endif %}>Ascending</option>
      </select>
      <button type="submit">Apply</button>
    </form>
  </div>
  <table>
    <thead>
      <tr>
        <th>{{ sortable_header("No.", "invoice_number") }}</th>
        <th>{{ sortable_header("Date", "invoice_date") }}</th>
        <th>{{ sortable_header("Due", "due_date") }}</th>
        <th>{{ sortable_header("Customer", "customer") }}</th>
        <th>{{ sortable_header("Total", "total") }}</th>
        <th>Status</th>
        <th>Payment</th>
      </tr>
    </thead>
    <tbody>
      {% for inv in invoices %}
      <tr onclick="window.location='/invoices/{{ inv.id }}'" style="cursor:pointer;">
        <td>{{ inv.invoice_number }}</td>
        <td>{{ inv.invoice_date }}</td>
        <td>{{ inv.due_date }}</td>
        <td>{{ inv.customer }}</td>
        <td>{{ "%.2f"|format(inv.total) }} {{ inv.currency }}</td>
        <td>
          <span class="pill pill-open">{{ inv.status }}</span>
        </td>
        <td>
          {% if inv.payment_status == "paid" %}
            <span class="pill pill-paid">paid</span>
          {% elif inv.payment_status == "overdue" %}
            <span class="pill pill-overdue">overdue</span>
          {% else %}
            <span class="pill pill-open">{{ inv.payment_status }}</span>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="7" class="muted">No invoices found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %}
